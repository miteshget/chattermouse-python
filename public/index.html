<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ChatterMouse Application</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #343541;
            color: #ececf1;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Authentication Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #28292d 0%, #1e1d1f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            color: #333;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 18px;
            color: white;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .auth-subtitle {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .auth-button {
            width: 100%;
            padding: 12px 16px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 16px;
        }

        .auth-button:hover {
            background: #0d8f6b;
        }

        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-toggle {
            text-align: center;
            color: #666;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #10a37f;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: #999;
            font-size: 14px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e1e5e9;
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .google-signin-button {
            width: 100%;
            padding: 12px 16px;
            background: white;
            color: #333;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .google-signin-button:hover {
            background: #f7f7f7;
            border-color: #d1d5d9;
        }

        .google-signin-button:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-message {
            background: #f56565;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        /* Main Application Styles */
        .sidebar {
            width: 260px;
            background-color: #202123;
            border-right: 1px solid #4d4d4f;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 18px;
            border-bottom: 1px solid #4d4d4f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 90px;
            height: 50px;
            border-radius: 12px;
            background-color: #202123;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

            
        .logo img {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            object-fit: cover;
        }

        .app-info h1 {
            font-size: 16px;
            font-weight: 600;
            color: #ececf1;
        }

        .app-info p {
            font-size: 12px;
            color: #8e8ea0;
            margin-top: 2px;
        }

        .sidebar-nav {
            padding: 16px;
            border-bottom: 1px solid #4d4d4f;
        }

        .nav-button {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid #4d4d4f;
            border-radius: 8px;
            color: #ececf1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .nav-button:hover {
            background-color: #2a2b32;
        }

        .nav-button.active {
            background-color: #343541;
            border-color: #10a37f;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px;
        }

        .chat-history-item {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #ececf1;
            transition: background-color 0.2s ease;
        }

        .chat-history-item:hover {
            background-color: #2a2b32;
        }

        .chat-history-item.active {
            background-color: #343541;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #4d4d4f;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5436da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-weight: 500;
            color: #ececf1;
        }

        .logout-button {
            width: 100%;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid #4d4d4f;
            border-radius: 6px;
            color: #ececf1;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .logout-button:hover {
            background-color: #2a2b32;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .main-header {
            padding: 16px 24px;
            border-bottom: 1px solid #4d4d4f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: #ececf1;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .toggle-sidebar:hover {
            background-color: #2a2b32;
        }

        .model-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8e8ea0;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background-color: #343541;
        }

        .message-container {
            padding: 24px 0;
            border-bottom: 1px solid #4d4d4f;
        }

        .message-container:last-child {
            border-bottom: none;
        }

        .message-container.user {
            background-color: #343541;
        }

        .message-container.assistant {
            background-color: #444654;
        }

        .message-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            gap: 16px;
        }

        .message-avatar {
            min-width: 80px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
            padding: 0 8px;
            text-align: center;
            word-break: break-word;
        }

        .message-avatar.user {
            background: #5436da;
            color: white;
        }

        .message-avatar.assistant {
            background: #10a37f;
            color: white;
        }

        .message-text {
            flex: 1;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-input-container {
            padding: 24px;
            background-color: #343541;
        }

        .chat-input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 16px 56px 16px 16px;
            background-color: #40414f;
            border: 1px solid #565869;
            border-radius: 12px;
            color: #ececf1;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 32px;
            height: 32px;
            background: #10a37f;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .send-button:disabled {
            background: #565869;
            cursor: not-allowed;
        }

        .send-button:not(:disabled):hover {
            background: #0d8f6b;
        }

        .loading {
            display: none;
            padding: 24px 0;
            border-bottom: 1px solid #4d4d4f;
            background-color: #444654;
        }

        .loading-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .loading-avatar {
            min-width: 80px;
            height: 30px;
            border-radius: 4px;
            background: #10a37f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            padding: 0 8px;
            text-align: center;
            word-break: break-word;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8e8ea0;
            animation: loading 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }

        .welcome-logo {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            font-size: 32px;
            color: white;
        }

        .welcome-logo img {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            object-fit: cover;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #ececf1;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #8e8ea0;
            margin-bottom: 32px;
            max-width: 600px;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: #202123;
            border-left: 1px solid #4d4d4f;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 24px;
            border-bottom: 1px solid #4d4d4f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #ececf1;
        }

        .close-settings {
            background: none;
            border: none;
            color: #ececf1;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .close-settings:hover {
            background-color: #2a2b32;
        }

        .settings-content {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #ececf1;
            margin-bottom: 16px;
        }

        .settings-field {
            margin-bottom: 16px;
        }

        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ececf1;
            font-size: 14px;
        }

        .settings-input {
            width: 100%;
            padding: 12px 16px;
            background-color: #40414f;
            border: 1px solid #565869;
            border-radius: 8px;
            color: #ececf1;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .settings-input:focus {
            border-color: #10a37f;
        }

        .settings-input[type="password"] {
            font-family: monospace;
        }

        .settings-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-range input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            color: #8e8ea0;
        }

        .save-settings {
            width: 100%;
            padding: 12px 16px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .save-settings:hover {
            background: #0d8f6b;
        }

        .save-settings:disabled {
            background: #565869;
            cursor: not-allowed;
        }

        .error-message {
            background: #f56565;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 24px;
            border-left: 4px solid #e53e3e;
        }

        .success-message {
            background: #48bb78;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: 260px;
                transform: translateX(-100%);
            }

            .main-content {
                width: 100%;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }

            .message-content {
                padding: 0 16px;
            }

            .chat-input-container {
                padding: 16px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #565869;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6f7077;
        }

        .hidden {
            display: none !important;
        }

        .footer {
            padding: 12px 24px;
            text-align: center;
            font-size: 12px;
            color: #8e8ea0;
            border-top: 1px solid #4d4d4f;
            background-color: #343541;
        }

        .footer a {
            color: #10a37f;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo" id="authLogo"></div>
                <h1 class="auth-title" id="authTitle">ChatterMouse</h1>
                <p class="auth-subtitle" id="authSubtitle">Sign in to continue</p>
            </div>

            <div id="authError" class="error-message hidden"></div>

            <!-- Sign In Form -->
            <form id="signinForm">
                <!-- Google Sign-In Button -->
                <button type="button" class="google-signin-button" id="googleSigninButton">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>

                <div class="auth-divider">
                    <span>OR</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="signinUsername">Username or Email</label>
                    <input type="text" id="signinUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signinPassword">Password</label>
                    <input type="password" id="signinPassword" class="form-input" required>
                </div>
                <button type="submit" class="auth-button" id="signinButton">Sign In</button>
            </form>

            <!-- Sign Up Form -->
            <form id="signupForm" class="hidden">
                <!-- Google Sign-In Button -->
                <button type="button" class="google-signin-button" id="googleSignupButton">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign up with Google
                </button>

                <div class="auth-divider">
                    <span>OR</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-input" minlength="6" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" class="form-input" minlength="6" required>
                </div>
                <button type="submit" class="auth-button" id="signupButton">Sign Up</button>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotPasswordForm" class="hidden">
                <div class="form-group">
                    <label class="form-label" for="forgotUsernameOrEmail">Username or Email</label>
                    <input type="text" id="forgotUsernameOrEmail" class="form-input" required>
                </div>
                <button type="submit" class="auth-button" id="resetPasswordButton">Reset Password</button>
            </form>

            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <button type="button" id="authToggleButton">Sign Up</button>
            </div>

            <div class="auth-toggle" id="forgotPasswordSection">
                <button type="button" id="forgotPasswordButton">Forgot Password?</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" id="appLogo"></div>
            <div class="app-info">
                <h1 id="appTitle">ChatterMouse</h1>
                <p id="appSubtitle">AI Assistant</p>
            </div>
        </div>
        
        <div class="sidebar-nav">
            <button class="nav-button active" id="newChatBtn">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
            <button class="nav-button hidden" id="adminBtn">
                <i class="fas fa-user-shield"></i>
                <span>Admin Panel</span>
            </button>
        </div>
        
        <div class="chat-history" id="chatHistory">
            <!-- Chat history items will be populated here -->
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-name" id="userName">User</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="logout-button" id="accountBtn" style="flex: 1;">
                    <i class="fas fa-key"></i> Password
                </button>
                <button class="logout-button" id="logoutBtn" style="flex: 1;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="main-header">
            <button class="toggle-sidebar" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
            <div class="model-info">
                <i class="fas fa-brain"></i>
                <span id="modelName">granite-3-2-8b-instruct</span>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-logo" id="welcomeLogo"></div>
                <h1 class="welcome-title" id="welcomeTitle">ChatterMouse</h1>
                <p class="welcome-subtitle" id="welcomeSubtitle">Start a conversation with our AI assistant</p>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-content">
                <div class="loading-avatar" id="loadingAvatar">AI</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
                <span id="loadingMessage">Thinking...</span>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea
                    id="messageInput"
                    class="chat-input"
                    placeholder="Type your message here..."
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <div class="footer">
            Created by <strong>Mitesh The Mouse</strong> | Licensed under GPLv2
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="settings-panel" id="adminPanel">
        <div class="settings-header">
            <h2 class="settings-title">Admin Panel</h2>
            <button class="close-settings" id="closeAdmin">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="settings-content">
            <div id="adminError" class="error-message hidden"></div>
            <div id="adminSuccess" class="success-message hidden"></div>

            <!-- System-Wide Model Configuration -->
            <div class="settings-section">
                <h3 class="settings-section-title">System-Wide Model Configuration</h3>
                <p style="color: #8e8ea0; font-size: 13px; margin-bottom: 16px;">These settings apply to all users</p>

                <div class="settings-field">
                    <label class="settings-label" for="adminModelName">Model Name</label>
                    <input type="text" id="adminModelName" class="settings-input" placeholder="granite-3-2-8b-instruct">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminApiUrl">API URL</label>
                    <input type="url" id="adminApiUrl" class="settings-input" placeholder="https://api.example.com/v1/completions">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminApiToken">API Token</label>
                    <input type="password" id="adminApiToken" class="settings-input" placeholder="Your API token">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminMaxTokens">Max Tokens</label>
                    <input type="number" id="adminMaxTokens" class="settings-input" min="1" max="4096" value="512">
                </div>

                <div class="settings-field">
                    <label class="settings-label">Temperature: <span id="adminTempValue">0.7</span></label>
                    <input type="range" id="adminTemperature" min="0" max="1" step="0.1" value="0.7"
                           oninput="document.getElementById('adminTempValue').textContent = this.value">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminTimeout">Timeout (ms)</label>
                    <input type="number" id="adminTimeout" class="settings-input" min="1000" max="120000" value="30000">
                </div>

                <button type="button" class="save-settings" id="saveSystemSettingsBtn">
                    <i class="fas fa-save"></i> Save System Settings
                </button>
            </div>

            <!-- System Configuration Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">Google OAuth Configuration</h3>

                <div class="settings-field">
                    <label class="settings-label" for="adminGoogleClientId">Google Client ID</label>
                    <input type="text" id="adminGoogleClientId" class="settings-input" placeholder="your-client-id.apps.googleusercontent.com">
                    <small style="color: #8e8ea0; font-size: 12px; display: block; margin-top: 4px;">
                        Get this from <a href="https://console.cloud.google.com/" target="_blank" style="color: #10a37f;">Google Cloud Console</a>
                    </small>
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminGoogleClientSecret">Google Client Secret</label>
                    <input type="password" id="adminGoogleClientSecret" class="settings-input" placeholder="Your Google Client Secret">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="adminGoogleRedirectUri">Google Redirect URI</label>
                    <input type="text" id="adminGoogleRedirectUri" class="settings-input" placeholder="http://localhost:3000/api/auth/google/callback">
                    <small style="color: #8e8ea0; font-size: 12px; display: block; margin-top: 4px;">
                        Must match the authorized redirect URI in Google Cloud Console
                    </small>
                </div>

                <button type="button" class="save-settings" id="saveGoogleOAuthBtn">
                    <i class="fas fa-save"></i> Save Google OAuth Settings
                </button>
            </div>

            <!-- Stats Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">System Statistics</h3>
                <div style="background: #40414f; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #8e8ea0;">Total Users:</span>
                        <strong id="statTotalUsers">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #8e8ea0;">Admin Users:</span>
                        <strong id="statAdminUsers">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #8e8ea0;">Total Sessions:</span>
                        <strong id="statTotalSessions">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #8e8ea0;">Total Messages:</span>
                        <strong id="statTotalMessages">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #8e8ea0;">Registered Today:</span>
                        <strong id="statRegisteredToday">-</strong>
                    </div>
                </div>
                <button type="button" class="save-settings" id="refreshStatsBtn">
                    <i class="fas fa-sync"></i> Refresh Statistics
                </button>
            </div>

            <!-- User Management Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">User Management</h3>

                <!-- Create New User Form -->
                <div style="background: #2a2b32; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #565869;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #10a37f;">
                        <i class="fas fa-user-plus"></i> Create New User
                    </h4>

                    <div class="settings-field">
                        <label class="settings-label" for="newUsername">Username</label>
                        <input type="text" id="newUsername" class="settings-input" placeholder="username" minlength="3" maxlength="30">
                    </div>

                    <div class="settings-field">
                        <label class="settings-label" for="newUserEmail">Email</label>
                        <input type="email" id="newUserEmail" class="settings-input" placeholder="user@example.com">
                    </div>

                    <div class="settings-field">
                        <label class="settings-label" for="newUserPassword">Password</label>
                        <input type="password" id="newUserPassword" class="settings-input" placeholder="Enter password" minlength="6">
                    </div>

                    <div class="settings-field">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #ececf1;">
                            <input type="checkbox" id="newUserIsAdmin" style="width: auto; cursor: pointer;">
                            <span>Make this user an administrator</span>
                        </label>
                    </div>

                    <button type="button" class="save-settings" id="createUserBtn">
                        <i class="fas fa-user-plus"></i> Create User
                    </button>
                </div>

                <!-- Users List -->
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #ececf1;">Existing Users</h4>
                <div id="usersList" style="background: #40414f; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <!-- Users will be loaded here -->
                </div>
                <button type="button" class="save-settings" id="refreshUsersBtn" style="margin-top: 16px;">
                    <i class="fas fa-sync"></i> Refresh Users
                </button>
            </div>
        </div>
    </div>

    <!-- User Account Panel (Password Change Only) -->
    <div class="settings-panel" id="userAccountPanel">
        <div class="settings-header">
            <h2 class="settings-title">Account Settings</h2>
            <button class="close-settings" id="closeUserAccount">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="settings-content">
            <div id="accountError" class="error-message hidden"></div>
            <div id="accountSuccess" class="success-message hidden"></div>

            <div class="settings-section">
                <h3 class="settings-section-title">Change Password</h3>

                <div class="settings-field">
                    <label class="settings-label" for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" class="settings-input" placeholder="Enter current password">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="newPassword">New Password</label>
                    <input type="password" id="newPassword" class="settings-input" placeholder="Enter new password" minlength="6">
                </div>

                <div class="settings-field">
                    <label class="settings-label" for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" class="settings-input" placeholder="Confirm new password" minlength="6">
                </div>

                <button type="button" class="save-settings" id="changePasswordBtn">
                    <i class="fas fa-lock"></i> Change Password
                </button>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.token = localStorage.getItem('authToken');
                this.user = null;
                this.config = {};
                this.userSettings = {};
                this.conversationHistory = [];
                this.chatSessions = [];
                this.currentChatId = null;
                this.isMobile = window.innerWidth <= 768;
                this.currentView = 'signin'; // 'signin', 'signup', or 'forgot'

                this.initializeElements();
                this.initEventListeners();

                // Load auth logo immediately on page load
                this.loadAuthLogo();

                // Check for OAuth callback token in URL
                this.checkOAuthCallback();

                if (this.token) {
                    this.verifyToken();
                } else {
                    this.showAuth();
                }
            }

            checkOAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const error = urlParams.get('error');

                if (token) {
                    // Store token and remove from URL
                    this.token = token;
                    localStorage.setItem('authToken', token);
                    window.history.replaceState({}, document.title, '/');
                    this.verifyToken();
                } else if (error) {
                    // Show error and remove from URL
                    this.showAuthError('Google sign-in failed. Please try again.');
                    window.history.replaceState({}, document.title, '/');
                }
            }

            initializeElements() {
                // Auth elements
                this.authContainer = document.getElementById('authContainer');
                this.signinForm = document.getElementById('signinForm');
                this.signupForm = document.getElementById('signupForm');
                this.forgotPasswordForm = document.getElementById('forgotPasswordForm');
                this.authToggleButton = document.getElementById('authToggleButton');
                this.authToggleText = document.getElementById('authToggleText');
                this.forgotPasswordButton = document.getElementById('forgotPasswordButton');
                this.forgotPasswordSection = document.getElementById('forgotPasswordSection');
                this.authError = document.getElementById('authError');
                this.googleSigninButton = document.getElementById('googleSigninButton');
                this.googleSignupButton = document.getElementById('googleSignupButton');

                // Main app elements
                this.sidebar = document.getElementById('sidebar');
                this.toggleSidebar = document.getElementById('toggleSidebar');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.adminBtn = document.getElementById('adminBtn');
                this.accountBtn = document.getElementById('accountBtn');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.chatHistory = document.getElementById('chatHistory');
                this.userName = document.getElementById('userName');
                this.userAvatar = document.getElementById('userAvatar');

                // Chat elements
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatMessages = document.getElementById('chatMessages');
                this.loading = document.getElementById('loading');
                this.welcomeScreen = document.getElementById('welcomeScreen');

                // User Account elements
                this.userAccountPanel = document.getElementById('userAccountPanel');
                this.closeUserAccount = document.getElementById('closeUserAccount');
                this.accountError = document.getElementById('accountError');
                this.accountSuccess = document.getElementById('accountSuccess');
                this.changePasswordBtn = document.getElementById('changePasswordBtn');

                // Admin elements
                this.adminPanel = document.getElementById('adminPanel');
                this.closeAdmin = document.getElementById('closeAdmin');
                this.adminError = document.getElementById('adminError');
                this.adminSuccess = document.getElementById('adminSuccess');
                this.saveSystemSettingsBtn = document.getElementById('saveSystemSettingsBtn');
                this.saveGoogleOAuthBtn = document.getElementById('saveGoogleOAuthBtn');
                this.refreshStatsBtn = document.getElementById('refreshStatsBtn');
                this.refreshUsersBtn = document.getElementById('refreshUsersBtn');
            }

            initEventListeners() {
                // Auth events
                this.signinForm.addEventListener('submit', (e) => this.handleSignin(e));
                this.signupForm.addEventListener('submit', (e) => this.handleSignup(e));
                this.forgotPasswordForm.addEventListener('submit', (e) => this.handleForgotPassword(e));
                this.authToggleButton.addEventListener('click', () => this.toggleAuthView());
                this.forgotPasswordButton.addEventListener('click', () => this.showForgotPassword());
                this.googleSigninButton.addEventListener('click', () => this.handleGoogleSignin());
                this.googleSignupButton.addEventListener('click', () => this.handleGoogleSignin());

                // Main app events
                this.toggleSidebar.addEventListener('click', () => this.toggleSidebarVisibility());
                this.newChatBtn.addEventListener('click', () => this.startNewChat());
                this.accountBtn.addEventListener('click', () => this.openAccountPanel());
                this.adminBtn.addEventListener('click', () => this.openAdminPanel());
                this.logoutBtn.addEventListener('click', () => this.logout());

                // Chat events
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.messageInput.addEventListener('input', () => {
                    this.autoResize();
                    this.updateSendButton();
                });

                // User Account events
                this.closeUserAccount.addEventListener('click', () => this.closeAccountPanel());
                this.changePasswordBtn.addEventListener('click', () => this.changePassword());

                // Admin events
                this.closeAdmin.addEventListener('click', () => this.closeAdminPanel());
                this.saveSystemSettingsBtn.addEventListener('click', () => this.saveSystemSettings());
                this.saveGoogleOAuthBtn.addEventListener('click', () => this.saveGoogleOAuthSettings());
                this.refreshStatsBtn.addEventListener('click', () => this.loadAdminStats());
                this.refreshUsersBtn.addEventListener('click', () => this.loadAdminUsers());
                document.getElementById('createUserBtn').addEventListener('click', () => this.createNewUser());

                // Mobile events
                if (this.isMobile) {
                    document.addEventListener('click', (e) => {
                        if (!this.sidebar.contains(e.target) && !this.toggleSidebar.contains(e.target)) {
                            this.sidebar.classList.remove('open');
                        }
                        if (!this.userAccountPanel.contains(e.target) && !this.accountBtn.contains(e.target)) {
                            this.userAccountPanel.classList.remove('open');
                        }
                    });
                }

                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                });
            }

            // Authentication methods
            showAuth() {
                this.authContainer.classList.remove('hidden');
            }

            hideAuth() {
                this.authContainer.classList.add('hidden');
            }

            toggleAuthView() {
                if (this.currentView === 'signin') {
                    this.currentView = 'signup';
                    this.signinForm.classList.add('hidden');
                    this.signupForm.classList.remove('hidden');
                    this.forgotPasswordForm.classList.add('hidden');
                    this.authToggleText.textContent = 'Already have an account?';
                    this.authToggleButton.textContent = 'Sign In';
                    this.forgotPasswordSection.style.display = 'none';
                    document.getElementById('authSubtitle').textContent = 'Create your account';
                } else {
                    this.currentView = 'signin';
                    this.signupForm.classList.add('hidden');
                    this.signinForm.classList.remove('hidden');
                    this.forgotPasswordForm.classList.add('hidden');
                    this.authToggleText.textContent = "Don't have an account?";
                    this.authToggleButton.textContent = 'Sign Up';
                    this.forgotPasswordSection.style.display = 'block';
                    document.getElementById('authSubtitle').textContent = 'Sign in to continue';
                }
                this.hideAuthError();
            }

            showForgotPassword() {
                this.currentView = 'forgot';
                this.signinForm.classList.add('hidden');
                this.signupForm.classList.add('hidden');
                this.forgotPasswordForm.classList.remove('hidden');
                this.authToggleText.textContent = 'Remember your password?';
                this.authToggleButton.textContent = 'Sign In';
                this.forgotPasswordSection.style.display = 'none';
                document.getElementById('authSubtitle').textContent = 'Reset your password';
                this.hideAuthError();
            }

            showAuthError(message) {
                this.authError.textContent = message;
                this.authError.classList.remove('hidden');
            }

            hideAuthError() {
                this.authError.classList.add('hidden');
            }

            async handleSignin(e) {
                e.preventDefault();
                const usernameOrEmail = document.getElementById('signinUsername').value;
                const password = document.getElementById('signinPassword').value;

                try {
                    const response = await fetch('/api/auth/signin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usernameOrEmail, password })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('authToken', this.token);
                        await this.initializeApp();
                    } else {
                        this.showAuthError(data.error);
                    }
                } catch (error) {
                    this.showAuthError('Connection error. Please try again.');
                }
            }

            async handleSignup(e) {
                e.preventDefault();
                const username = document.getElementById('signupUsername').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

                if (password !== passwordConfirm) {
                    this.showAuthError('Passwords do not match');
                    return;
                }

                try {
                    const response = await fetch('/api/auth/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('authToken', this.token);
                        await this.initializeApp();
                    } else {
                        this.showAuthError(data.error);
                    }
                } catch (error) {
                    this.showAuthError('Connection error. Please try again.');
                }
            }

            async handleForgotPassword(e) {
                e.preventDefault();
                const usernameOrEmail = document.getElementById('forgotUsernameOrEmail').value;

                try {
                    const response = await fetch('/api/auth/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usernameOrEmail })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        this.showAuthError(`Password reset successful. ${data.tempPassword ? 'Temporary password: ' + data.tempPassword : 'Check your console for the temporary password.'}`);
                    } else {
                        this.showAuthError(data.error);
                    }
                } catch (error) {
                    this.showAuthError('Connection error. Please try again.');
                }
            }

            async handleGoogleSignin() {
                try {
                    // Disable button to prevent multiple clicks
                    this.googleSigninButton.disabled = true;
                    this.googleSignupButton.disabled = true;

                    // Get Google OAuth URL from backend
                    const response = await fetch('/api/auth/google', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();

                    if (response.ok && data.authUrl) {
                        // Redirect to Google OAuth
                        window.location.href = data.authUrl;
                    } else {
                        this.showAuthError(data.error || 'Failed to initiate Google sign-in');
                        this.googleSigninButton.disabled = false;
                        this.googleSignupButton.disabled = false;
                    }
                } catch (error) {
                    this.showAuthError('Failed to connect to Google. Please try again.');
                    this.googleSigninButton.disabled = false;
                    this.googleSignupButton.disabled = false;
                }
            }

            async verifyToken() {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.user = data.user;
                        await this.initializeApp();
                    } else {
                        localStorage.removeItem('authToken');
                        this.token = null;
                        this.showAuth();
                    }
                } catch (error) {
                    localStorage.removeItem('authToken');
                    this.token = null;
                    this.showAuth();
                }
            }

            logout() {
                localStorage.removeItem('authToken');
                this.token = null;
                this.user = null;
                this.showAuth();
                this.userAccountPanel.classList.remove('open');
                this.adminPanel.classList.remove('open');
            }

            // Application initialization
            async initializeApp() {
                this.hideAuth();
                await this.loadConfig();
                this.updateUserInfo();
                // Load existing sessions
                await this.loadSessions();
                // Add a small delay to ensure DOM is ready
                setTimeout(() => {
                    // Only start new chat if no sessions exist
                    if (this.chatSessions.length === 0) {
                        this.startNewChat();
                    }
                }, 100);
            }

            loadAuthLogo() {
                const authLogo = document.getElementById('authLogo');
                if (authLogo) {
                    const img = document.createElement('img');
                    img.src = '/images/logo.png?t=' + Date.now();
                    img.alt = 'Logo';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.borderRadius = 'inherit';
                    img.style.objectFit = 'cover';
                    authLogo.innerHTML = '';
                    authLogo.appendChild(img);
                }
            }

            updateUserInfo() {
                if (this.user) {
                    this.userName.textContent = this.user.username;
                    this.userAvatar.textContent = this.user.username.charAt(0).toUpperCase();

                    // Show admin button if user is admin
                    if (this.user.is_admin) {
                        this.adminBtn.classList.remove('hidden');
                    } else {
                        this.adminBtn.classList.add('hidden');
                    }
                }
            }

            // API methods with authentication
            async apiCall(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`,
                    ...options.headers
                };

                return fetch(endpoint, { ...options, headers });
            }

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    this.config = await response.json();
                    this.applyConfig();
                } catch (error) {
                    console.error('Failed to load config:', error);
                }
            }

            applyConfig() {
                document.getElementById('pageTitle').textContent = this.config.appTitle;
                document.title = this.config.appTitle;
                document.getElementById('appTitle').textContent = this.config.appTitle;
                document.getElementById('appSubtitle').textContent = this.config.appSubtitle;
                document.getElementById('welcomeTitle').textContent = this.config.appTitle;
                document.getElementById('welcomeSubtitle').textContent = this.config.appSubtitle;
                document.getElementById('authTitle').textContent = this.config.appTitle;
                this.messageInput.placeholder = this.config.inputPlaceholder;
                document.getElementById('loadingMessage').textContent = this.config.loadingMessage;
                document.getElementById('loadingAvatar').textContent = this.config.chatAssistantName;

                // Update logos to use local logo.png
                const logos = [document.getElementById('appLogo'), document.getElementById('welcomeLogo'), document.getElementById('authLogo')];
                logos.forEach(logo => {
                    if (logo) {
                        const img = document.createElement('img');
                        img.src = '/images/logo.png';
                        img.alt = 'Logo';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.borderRadius = 'inherit';
                        img.style.objectFit = 'cover';
                        logo.innerHTML = '';
                        logo.appendChild(img);
                    }
                });
            }


            // User Account Panel methods
            openAccountPanel() {
                this.userAccountPanel.classList.add('open');
                this.newChatBtn.classList.remove('active');
            }

            closeAccountPanel() {
                this.userAccountPanel.classList.remove('open');
                this.newChatBtn.classList.add('active');
            }

            showAccountError(message) {
                this.accountError.textContent = message;
                this.accountError.classList.remove('hidden');
            }

            hideAccountError() {
                this.accountError.classList.add('hidden');
            }

            showAccountSuccess(message) {
                this.accountSuccess.textContent = message;
                this.accountSuccess.classList.remove('hidden');
            }

            hideAccountSuccess() {
                this.accountSuccess.classList.add('hidden');
            }

            async changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    this.showAccountError('All password fields are required');
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    this.showAccountError('New passwords do not match');
                    return;
                }

                if (newPassword.length < 6) {
                    this.showAccountError('New password must be at least 6 characters long');
                    return;
                }

                try {
                    const response = await this.apiCall('/api/auth/change-password', {
                        method: 'POST',
                        body: JSON.stringify({ currentPassword, newPassword })
                    });

                    if (response.ok) {
                        this.showAccountSuccess('Password changed successfully!');
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmNewPassword').value = '';
                        setTimeout(() => this.hideAccountSuccess(), 3000);
                    } else {
                        const data = await response.json();
                        this.showAccountError(data.error);
                    }
                } catch (error) {
                    this.showAccountError('Failed to change password. Please try again.');
                }
            }

            // Chat methods (updated for authentication)
            toggleSidebarVisibility() {
                if (this.isMobile) {
                    this.sidebar.classList.toggle('open');
                } else {
                    this.sidebar.classList.toggle('collapsed');
                }
            }

            async startNewChat() {
                this.currentChatId = Date.now().toString();
                this.conversationHistory = [];
                this.chatMessages.innerHTML = '';
                this.welcomeScreen.style.display = 'flex';
                this.addMessage('assistant', this.config.welcomeMessage);

                // Ensure welcome logo is loaded
                this.loadWelcomeLogo();

                // Create session in database
                await this.createSession();

                // Update active session in sidebar
                this.updateSessionList();

                this.closeSettingsPanel();
                this.closeAdminPanel();
                if (this.isMobile) {
                    this.sidebar.classList.remove('open');
                }
            }

            async createSession() {
                try {
                    await this.apiCall('/api/sessions', {
                        method: 'POST',
                        body: JSON.stringify({
                            sessionId: this.currentChatId,
                            title: 'New Chat'
                        })
                    });
                } catch (error) {
                    console.error('Failed to create session:', error);
                }
            }

            loadWelcomeLogo() {
                // Add a small delay to ensure the welcome screen is visible
                setTimeout(() => {
                    const welcomeLogo = document.getElementById('welcomeLogo');
                    if (welcomeLogo) {
                        const img = document.createElement('img');
                        img.src = '/images/logo.png?t=' + Date.now(); // Cache busting
                        img.alt = 'Logo';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.borderRadius = 'inherit';
                        img.style.objectFit = 'cover';
                        welcomeLogo.innerHTML = '';
                        welcomeLogo.appendChild(img);
                    }
                }, 50);
            }

            autoResize() {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 200) + 'px';
            }

            updateSendButton() {
                const hasText = this.messageInput.value.trim().length > 0;
                this.sendButton.disabled = !hasText;
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                if (this.welcomeScreen.style.display !== 'none') {
                    this.welcomeScreen.style.display = 'none';
                }

                const isFirstMessage = this.conversationHistory.length === 0;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.autoResize();
                this.updateSendButton();
                this.setLoading(true);

                try {
                    const response = await this.apiCall('/api/chat', {
                        method: 'POST',
                        body: JSON.stringify({
                            message: message,
                            history: this.conversationHistory,
                            sessionId: this.currentChatId
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.addMessage('assistant', data.response);

                        this.conversationHistory.push(
                            { role: 'user', content: message },
                            { role: 'assistant', content: data.response }
                        );

                        const maxHistory = this.config.maxConversationHistory || 30;
                        if (this.conversationHistory.length > maxHistory) {
                            this.conversationHistory = this.conversationHistory.slice(-maxHistory);
                        }

                        // Update session title with first user message
                        if (isFirstMessage) {
                            await this.updateSessionTitle(this.currentChatId, message);
                            await this.loadSessions(); // Reload sessions to update sidebar
                        }
                    } else {
                        const errorData = await response.json();
                        if (response.status === 401 || response.status === 403) {
                            this.logout();
                            return;
                        }
                        this.showError(`Error: ${errorData.error}`);
                    }
                } catch (error) {
                    this.showError(`Error: ${error.message}`);
                } finally {
                    this.setLoading(false);
                }
            }

            addMessage(role, content) {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${role}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                const avatar = document.createElement('div');
                avatar.className = `message-avatar ${role}`;
                avatar.textContent = role === 'user' ? 
                    (this.user ? this.user.username : 'You') : 
                    (this.config.chatAssistantName || 'ChatterMouse');
                
                const messageText = document.createElement('div');
                messageText.className = 'message-text';
                messageText.textContent = content;
                
                messageContent.appendChild(avatar);
                messageContent.appendChild(messageText);
                messageContainer.appendChild(messageContent);
                
                this.chatMessages.appendChild(messageContainer);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                this.chatMessages.appendChild(errorDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            setLoading(isLoading) {
                this.loading.style.display = isLoading ? 'block' : 'none';
                this.sendButton.disabled = isLoading || !this.messageInput.value.trim();
                this.messageInput.disabled = isLoading;

                if (isLoading) {
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }
            }

            // Admin Panel Methods
            openAdminPanel() {
                this.adminPanel.classList.add('open');
                this.userAccountPanel.classList.remove('open');
                this.newChatBtn.classList.remove('active');
                this.adminBtn.classList.add('active');

                // Load admin data
                this.loadSystemSettings();
                this.loadGoogleOAuthSettings();
                this.loadAdminStats();
                this.loadAdminUsers();
            }

            closeAdminPanel() {
                this.adminPanel.classList.remove('open');
                this.adminBtn.classList.remove('active');
                this.newChatBtn.classList.add('active');
            }

            showAdminError(message) {
                this.adminError.textContent = message;
                this.adminError.classList.remove('hidden');
                setTimeout(() => this.hideAdminError(), 5000);
            }

            hideAdminError() {
                this.adminError.classList.add('hidden');
            }

            showAdminSuccess(message) {
                this.adminSuccess.textContent = message;
                this.adminSuccess.classList.remove('hidden');
                setTimeout(() => this.hideAdminSuccess(), 3000);
            }

            hideAdminSuccess() {
                this.adminSuccess.classList.add('hidden');
            }

            async loadSystemSettings() {
                try {
                    const response = await this.apiCall('/api/admin/system-settings');
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('adminModelName').value = data.modelName || '';
                        document.getElementById('adminApiUrl').value = data.apiUrl || '';
                        document.getElementById('adminApiToken').value = data.apiToken || '';
                        document.getElementById('adminMaxTokens').value = data.maxTokens || 512;
                        document.getElementById('adminTemperature').value = data.temperature || 0.7;
                        document.getElementById('adminTempValue').textContent = data.temperature || 0.7;
                        document.getElementById('adminTimeout').value = data.timeout || 30000;
                    }
                } catch (error) {
                    console.error('Failed to load system settings:', error);
                }
            }

            async saveSystemSettings() {
                try {
                    const settings = {
                        modelName: document.getElementById('adminModelName').value,
                        apiUrl: document.getElementById('adminApiUrl').value,
                        apiToken: document.getElementById('adminApiToken').value,
                        maxTokens: parseInt(document.getElementById('adminMaxTokens').value),
                        temperature: parseFloat(document.getElementById('adminTemperature').value),
                        timeout: parseInt(document.getElementById('adminTimeout').value)
                    };

                    const response = await this.apiCall('/api/admin/system-settings', {
                        method: 'PUT',
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        this.showAdminSuccess('System settings saved successfully! These settings apply to all users.');
                    } else {
                        const data = await response.json();
                        this.showAdminError(data.error || 'Failed to save system settings');
                    }
                } catch (error) {
                    this.showAdminError('Failed to save system settings');
                }
            }

            async loadGoogleOAuthSettings() {
                try {
                    const response = await this.apiCall('/api/admin/google-oauth');
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('adminGoogleClientId').value = data.clientId || '';
                        document.getElementById('adminGoogleClientSecret').value = data.clientSecret || '';
                        document.getElementById('adminGoogleRedirectUri').value = data.redirectUri || 'http://localhost:3000/api/auth/google/callback';
                    }
                } catch (error) {
                    console.error('Failed to load Google OAuth settings:', error);
                }
            }

            async saveGoogleOAuthSettings() {
                try {
                    const settings = {
                        clientId: document.getElementById('adminGoogleClientId').value,
                        clientSecret: document.getElementById('adminGoogleClientSecret').value,
                        redirectUri: document.getElementById('adminGoogleRedirectUri').value
                    };

                    const response = await this.apiCall('/api/admin/google-oauth', {
                        method: 'PUT',
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        this.showAdminSuccess('Google OAuth settings saved successfully! Restart the server to apply changes.');
                    } else {
                        const data = await response.json();
                        this.showAdminError(data.error || 'Failed to save Google OAuth settings');
                    }
                } catch (error) {
                    this.showAdminError('Failed to save Google OAuth settings');
                }
            }

            async loadAdminStats() {
                try {
                    const response = await this.apiCall('/api/admin/stats');
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('statTotalUsers').textContent = data.totalUsers;
                        document.getElementById('statAdminUsers').textContent = data.adminUsers;
                        document.getElementById('statTotalSessions').textContent = data.totalSessions;
                        document.getElementById('statTotalMessages').textContent = data.totalMessages;
                        document.getElementById('statRegisteredToday').textContent = data.registeredToday;
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                }
            }

            async loadAdminUsers() {
                try {
                    const response = await this.apiCall('/api/admin/users');
                    if (response.ok) {
                        const data = await response.json();
                        const usersList = document.getElementById('usersList');

                        if (data.users.length === 0) {
                            usersList.innerHTML = '<p style="color: #8e8ea0; text-align: center;">No users found</p>';
                            return;
                        }

                        usersList.innerHTML = data.users.map(user => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #565869;">
                                <div>
                                    <div style="font-weight: 600;">${user.username}</div>
                                    <div style="font-size: 12px; color: #8e8ea0;">${user.email}</div>
                                    ${user.is_admin ? '<span style="font-size: 11px; background: #10a37f; color: white; padding: 2px 8px; border-radius: 4px; margin-top: 4px; display: inline-block;">Admin</span>' : ''}
                                </div>
                                ${!user.is_admin || user.id !== this.user.id ? `
                                    <button onclick="app.deleteUser(${user.id}, '${user.username}')"
                                            style="background: #f56565; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                ` : ''}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Failed to load users:', error);
                }
            }

            async deleteUser(userId, username) {
                if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                    return;
                }

                try {
                    const response = await this.apiCall(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showAdminSuccess(`User "${username}" deleted successfully`);
                        this.loadAdminUsers();
                        this.loadAdminStats();
                    } else {
                        const data = await response.json();
                        this.showAdminError(data.error || 'Failed to delete user');
                    }
                } catch (error) {
                    this.showAdminError('Failed to delete user');
                }
            }

            async createNewUser() {
                try {
                    const username = document.getElementById('newUsername').value;
                    const email = document.getElementById('newUserEmail').value;
                    const password = document.getElementById('newUserPassword').value;
                    const isAdmin = document.getElementById('newUserIsAdmin').checked;

                    // Validation
                    if (!username || !email || !password) {
                        this.showAdminError('All fields are required');
                        return;
                    }

                    if (username.length < 3 || username.length > 30) {
                        this.showAdminError('Username must be 3-30 characters');
                        return;
                    }

                    if (password.length < 6) {
                        this.showAdminError('Password must be at least 6 characters');
                        return;
                    }

                    const response = await this.apiCall('/api/admin/users', {
                        method: 'POST',
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            password: password,
                            isAdmin: isAdmin
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showAdminSuccess(`User "${data.user.username}" created successfully!`);

                        // Clear form
                        document.getElementById('newUsername').value = '';
                        document.getElementById('newUserEmail').value = '';
                        document.getElementById('newUserPassword').value = '';
                        document.getElementById('newUserIsAdmin').checked = false;

                        // Refresh users list and stats
                        this.loadAdminUsers();
                        this.loadAdminStats();
                    } else {
                        const data = await response.json();
                        this.showAdminError(data.error || 'Failed to create user');
                    }
                } catch (error) {
                    this.showAdminError('Failed to create user');
                }
            }

            // Session Management Methods
            async loadSessions() {
                try {
                    const response = await this.apiCall('/api/sessions');
                    if (response.ok) {
                        const data = await response.json();
                        this.chatSessions = data.sessions || [];
                        this.updateSessionList();
                    }
                } catch (error) {
                    console.error('Failed to load sessions:', error);
                }
            }

            updateSessionList() {
                const chatHistory = this.chatHistory;

                if (this.chatSessions.length === 0) {
                    chatHistory.innerHTML = '<div style="padding: 16px; text-align: center; color: #8e8ea0; font-size: 14px;">No chat history yet</div>';
                    return;
                }

                chatHistory.innerHTML = this.chatSessions.map(session => `
                    <div class="chat-history-item ${session.id === this.currentChatId ? 'active' : ''}"
                         onclick="app.loadSession('${session.id}')"
                         style="cursor: pointer; position: relative; padding-right: 40px;">
                        <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <i class="fas fa-comment" style="margin-right: 8px;"></i>
                            ${session.title || 'New Chat'}
                        </div>
                        <button onclick="event.stopPropagation(); app.deleteSessionConfirm('${session.id}')"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #8e8ea0; cursor: pointer; padding: 4px 8px; border-radius: 4px; opacity: 0.6;"
                                onmouseover="this.style.opacity='1'; this.style.background='#2a2b32'"
                                onmouseout="this.style.opacity='0.6'; this.style.background='transparent'">
                            <i class="fas fa-trash" style="font-size: 12px;"></i>
                        </button>
                    </div>
                `).join('');
            }

            async loadSession(sessionId) {
                try {
                    // Load messages for this session
                    const response = await this.apiCall(`/api/sessions/${sessionId}/messages`);

                    if (response.ok) {
                        const data = await response.json();

                        // Set current session
                        this.currentChatId = sessionId;

                        // Clear current chat
                        this.chatMessages.innerHTML = '';
                        this.welcomeScreen.style.display = 'none';
                        this.conversationHistory = [];

                        // Load messages
                        data.messages.forEach(msg => {
                            this.addMessage(msg.role, msg.content);
                            this.conversationHistory.push({
                                role: msg.role,
                                content: msg.content
                            });
                        });

                        // Update active session in sidebar
                        this.updateSessionList();

                        // Close sidebar on mobile
                        if (this.isMobile) {
                            this.sidebar.classList.remove('open');
                        }
                    }
                } catch (error) {
                    console.error('Failed to load session:', error);
                    this.showError('Failed to load chat session');
                }
            }

            async deleteSessionConfirm(sessionId) {
                if (!confirm('Are you sure you want to delete this chat?')) {
                    return;
                }

                try {
                    const response = await this.apiCall(`/api/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        // Remove from local sessions
                        this.chatSessions = this.chatSessions.filter(s => s.id !== sessionId);

                        // If deleted session was active, start new chat
                        if (this.currentChatId === sessionId) {
                            this.startNewChat();
                        } else {
                            this.updateSessionList();
                        }
                    }
                } catch (error) {
                    console.error('Failed to delete session:', error);
                    this.showError('Failed to delete chat session');
                }
            }

            async updateSessionTitle(sessionId, firstMessage) {
                try {
                    // Generate title from first message (max 50 chars)
                    const title = firstMessage.length > 50
                        ? firstMessage.substring(0, 50) + '...'
                        : firstMessage;

                    await this.apiCall(`/api/sessions/${sessionId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ title })
                    });

                    // Update local session
                    const session = this.chatSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.title = title;
                        this.updateSessionList();
                    }
                } catch (error) {
                    console.error('Failed to update session title:', error);
                }
            }
        }

        // Global app instance
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new ChatApp();
        });
    </script>
</body>
</html>